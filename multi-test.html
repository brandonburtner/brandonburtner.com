<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multiplication Flash Cards - Leitner System</title>
  <style>
    html, body {
    overscroll-behavior-y: contain; /* Prevents pull-to-refresh on Android Chrome */
  }
    body {
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }

    .global-timer {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .card {
      text-align: center;
      margin-top: 80px;
    }

    .problem {
      font-size: 4rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    input[type="number"] {
      font-size: 2rem;
      padding: 0.5rem 1rem;
      width: 150px;
      text-align: center;
      border: 2px solid #ccc;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    button {
      font-size: 1.25rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin: 0.5rem;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    button.selected {
      background-color: #003366;
    }

    button:disabled {
      background-color: #d6d6d6; 
      color: #a0a0a0;          
      cursor: default;      
      opacity: 0;
    }

    .feedback {
      margin-top: 1rem;
      font-size: 1.5rem;
    }

    .timer {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    .difficulty-select,
    .summary-screen {
      text-align: center;
      margin-top: 100px;
    }

    #submitBtn, #nextBtn, #playBtn {
      display: none;
    }

    .global-timer {
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
  box-sizing: border-box;
  display: none; /* respect the hidden class */
}

.global-timer:not(.hidden) {
  display: flex;
}

#globalTimer {
  font-size: 1.5rem;
  font-weight: bold;
}

#sessionScore {
  font-size: 1.5rem;
  font-weight: bold;
}

.timer-left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

    #pausePlayBtn {
  outline: none;
  background: none;
}

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
    <div class="global-timer hidden" id="globalTimerWrapper">
      <div class="timer-left">
        <div id="globalTimer">Time remaining: 10:00</div>
        <button id="pausePlayBtn" aria-label="Pause">
          <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24">
            <rect x="6" y="4" width="4" height="16" fill="#000"/>
            <rect x="14" y="4" width="4" height="16" fill="#000"/>
          </svg>
          <svg id="playIcon" class="hidden" width="24" height="24" viewBox="0 0 24 24">
            <polygon points="6,4 20,12 6,20" fill="#000"/>
          </svg>
        </button>
      </div>
      <div id="sessionScore">Score: 0</div>
    </div>

  <div class="card hidden" id="card">
    <div class="timer" id="timer">Time left: </div>
    <div class="problem" id="problem">3 Ã— 4</div>
    <input type="number" id="answer" placeholder="Answer" />
    <div>
      <button id="submitBtn">Submit</button>
      <button id="nextBtn">Next</button>
    </div>
    <div class="feedback" id="feedback"></div>
  </div>

  <div id="pauseOverlay" class="hidden" style="text-align: center; margin-top: 100px;">
    <h1 style="font-size: 3rem; font-weight: bold;">Paused</h1>
    <button id="resumeBtn" aria-label="Resume" style="background: none; border: none; margin-top: 2rem; cursor: pointer;">
      <svg width="64" height="64" viewBox="0 0 64 64">
        <polygon points="16,12 52,32 16,52" fill="#000"/>
      </svg>
    </button>
  </div>

  <div class="difficulty-select" id="difficultySelect">
    <h2>Select Difficulty</h2>
    <button onclick="setDifficulty('beginner', this)">Beginner</button>
    <button onclick="setDifficulty('intermediate', this)">Intermediate</button>
    <button onclick="setDifficulty('advanced', this)">Advanced</button>

    <h2 style="margin-top: 2rem;">Select Time</h2>
    <button onclick="setTime(60, this)">1 Minute</button>
    <button onclick="setTime(300, this)">5 Minutes</button>
    <button onclick="setTime(600, this)">10 Minutes</button>

    <div style="margin-top: 2rem;">
      <button id="playBtn" onclick="startSession()">Play</button>
    </div>
  </div>

  <div class="summary-screen hidden" id="summaryScreen">
    <p id="summaryText"></p>
    <button id="startOverBtn">Start Over</button>
    <button id="historyBtn">History</button>
  </div>

  <div class="summary-screen hidden" id="historyScreen">
    <canvas id="historyChart" width="800" height="400"></canvas>
    <div style="margin-top: 2rem;">
      <button id="goBackBtn">Go Back</button>
    </div>
  </div>

  <script src="https://brandonburtner.com/confetti.browser.js"></script>
  <script>
    const SESSION_KEY = 'activeSession';

    function saveSessionData() {
      const sessionData = {
        currentQuestion,
        sessionScore,
        globalTimeRemaining,
        currentDifficulty,
        userSelectedTime,
        correctAnswers,
        incorrectAnswers: totalAnswered - correctAnswers
      };
      localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
    }
    
    function clearSessionData() {
      localStorage.removeItem(SESSION_KEY);
    }
    
    function resumeSession(data) {
      currentQuestion = data.currentQuestion;
      sessionScore = data.sessionScore;
      globalTimeRemaining = data.globalTimeRemaining;
      currentDifficulty = data.currentDifficulty;
      userSelectedTime = data.userSelectedTime;
      correctAnswers = data.correctAnswers;
      totalAnswered = data.correctAnswers + data.incorrectAnswers;
      totalTimeSpent = userSelectedTime - globalTimeRemaining;
    
      globalTimerEl.textContent = `Time remaining: ${formatTime(globalTimeRemaining)}`;
      document.getElementById("sessionScore").textContent = `Score: ${sessionScore}`;
    
      difficultyUI.classList.add('hidden');
      globalTimerWrapper.classList.remove('hidden');
      card.classList.remove('hidden');
      sessionActive = true;
    
      startGlobalTimer();
      renderCurrentProblem();
    }
    
    function renderCurrentProblem() {
      const [a, b] = currentQuestion.split("x").map(Number);
      problemEl.textContent = `${a} Ã— ${b}`;
      answerEl.value = '';
      feedbackEl.textContent = '';
      feedbackEl.style.color = '';
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'inline-block';
      submitBtn.disabled = false;
      answerEl.disabled = false;
      answerEl.focus();
      startTimer();
    }
    let sessionScore = 0;
    let allTimeScore = parseInt(localStorage.getItem("allTimeScore") || "0");
    let highScore = parseInt(localStorage.getItem("highScore") || "0");
    
    const scoreRules = {
      beginner: { correct: 2, incorrect: -1 },
      intermediate: { correct: 3, incorrect: -2 },
      advanced: { correct: 5, incorrect: -4 }
    };
    
    const globalTimerWrapper = document.getElementById('globalTimerWrapper');
    const globalTimerEl = document.getElementById('globalTimer');
    const pausePlayBtn = document.getElementById('pausePlayBtn');
    const pauseIcon = document.getElementById('pauseIcon');
    const playIcon = document.getElementById('playIcon');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const resumeBtn = document.getElementById('resumeBtn');

    const card = document.getElementById('card');
    const difficultyUI = document.getElementById('difficultySelect');
    const summaryUI = document.getElementById('summaryScreen');
    const summaryText = document.getElementById('summaryText');
    const startOverBtn = document.getElementById("startOverBtn");

    const problemEl = document.getElementById('problem');
    const answerEl = document.getElementById('answer');
    const feedbackEl = document.getElementById('feedback');
    const submitBtn = document.getElementById('submitBtn');
    const nextBtn = document.getElementById('nextBtn');
    const timerEl = document.getElementById('timer');
    const playBtn = document.getElementById('playBtn');

    let isPaused = false;
    let currentDifficulty = '';
    let globalTimeRemaining = 600;
    let userSelectedTime = null;
    let sessionActive = false;
    let globalTimer;
    let timer;
    let currentQuestion = null;
    let currentBox = null;
    let questionStartTime = null;
    let questionTimeLimit = 0;
    let timeRemaining = 0;
    let timedOut = false;

    let totalAnswered = 0;
    let correctAnswers = 0;
    let totalTimeSpent = 0;

    const timeLimits = {
      beginner: 20,
      intermediate: 10,
      advanced: 5
    };

    let permanentLeitnerSystem = loadLeitnerSystem();
    let tempLeitnerSystem = JSON.parse(JSON.stringify(permanentLeitnerSystem));

    pausePlayBtn.addEventListener('click', togglePause);
    resumeBtn.addEventListener('click', togglePause);
    startOverBtn.addEventListener("click", () => {
      summaryUI.classList.add('hidden');
      difficultyUI.classList.remove('hidden');
    });
    document.getElementById("goBackBtn").addEventListener("click", () => {
    document.getElementById('historyScreen').classList.add('hidden');
    summaryUI.classList.remove('hidden');
  });

    function updateSessionScore(correct) {
      const rule = scoreRules[currentDifficulty];
      if (!rule) return;
    
      sessionScore += correct ? rule.correct : rule.incorrect;
      if (sessionScore < 0) sessionScore = 0;
    
      document.getElementById("sessionScore").textContent = `Score: ${sessionScore}`;
    }
    
    function togglePause() {
      isPaused = !isPaused;
      if (isPaused) {
        clearInterval(globalTimer);
        card.classList.add('hidden');
        pauseOverlay.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        playIcon.classList.remove('hidden');
      } else {
        startGlobalTimer();
        card.classList.remove('hidden');
        pauseOverlay.classList.add('hidden');
        pauseIcon.classList.remove('hidden');
        playIcon.classList.add('hidden');
      }
    }

    function setDifficulty(level, btn) {
      currentDifficulty = level;
      highlightButton(btn, 'difficultySelect', ['Beginner', 'Intermediate', 'Advanced']);
      updatePlayButtonState();
    }

    function setTime(seconds, btn) {
      userSelectedTime = seconds;
      highlightButton(btn, 'difficultySelect', ['1 Minute', '5 Minutes', '10 Minutes']);
      updatePlayButtonState();
    }

    function highlightButton(clickedBtn, containerId, labels) {
      const buttons = document.querySelectorAll(`#${containerId} button`);
      buttons.forEach(btn => {
        if (labels.some(label => btn.textContent.includes(label))) {
          btn.classList.remove('selected');
        }
      });
      clickedBtn.classList.add('selected');
    }

    function updatePlayButtonState() {
      if (currentDifficulty && userSelectedTime) {
        playBtn.style.display = 'inline-block';
      }
    }

    function startSession() {
      tempLeitnerSystem = JSON.parse(JSON.stringify(permanentLeitnerSystem));
      difficultyUI.classList.add('hidden');
      globalTimeRemaining = userSelectedTime;
      globalTimerWrapper.classList.remove('hidden');
      card.classList.remove('hidden');
      sessionActive = true;
    
      totalAnswered = 0;
      correctAnswers = 0;
      totalTimeSpent = 0;
      sessionScore = 0;
      document.getElementById("sessionScore").textContent = "Score: 0";
    
      globalTimerEl.textContent = `Time remaining: ${formatTime(globalTimeRemaining)}`;
      startGlobalTimer();
      generateProblem();
    }

    function startGlobalTimer() {
      clearInterval(globalTimer);
      globalTimer = setInterval(() => {
        if (!isPaused) {
          globalTimeRemaining--;
          globalTimerEl.textContent = `Time remaining: ${formatTime(globalTimeRemaining)}`;
          if (globalTimeRemaining <= 0) {
            clearInterval(globalTimer);
            globalTimerEl.textContent = `â±ï¸ Time's up!`;
            sessionActive = false;
            disableInput();
            clearSessionData();
            showSummary();
          }
        }
      }, 1000);
    }

    function formatTime(seconds) {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function generateProblem() {
      const next = pickNextQuestion();
      if (!next) return;
      currentQuestion = next.question;
      currentBox = next.box;
      const [a, b] = currentQuestion.split("x").map(Number);
      problemEl.textContent = `${a} Ã— ${b}`;
      answerEl.value = '';
      feedbackEl.textContent = '';
      feedbackEl.style.color = '';
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'inline-block';
      submitBtn.disabled = false;
      nextBtn.disabled = false;
      answerEl.disabled = false;
      answerEl.focus();
      startTimer();
      saveSessionData();
    }

    function startTimer() {
      clearInterval(timer);
      questionTimeLimit = timeLimits[currentDifficulty];
      timeRemaining = questionTimeLimit;
      timerEl.textContent = `Time left: ${timeRemaining}s`;
      timedOut = false;
      questionStartTime = Date.now();
      timer = setInterval(() => {
      if (!isPaused) {
        timeRemaining--;
        if (timeRemaining >= 0) {
          timerEl.textContent = `Time left: ${timeRemaining}s`;
        }
        if (timeRemaining === 0) {
          timedOut = true;
          clearInterval(timer);
          timerEl.textContent = `â±ï¸ Time's up!`;
        }
      }
    }, 1000);
    }

    function pickNextQuestion() {
      const boxWeights = [
  { box: 'boxOne', questions: permanentLeitnerSystem.boxOne, weightPerQ: 7 },
  { box: 'boxTwo', questions: permanentLeitnerSystem.boxTwo, weightPerQ: 2 },
  { box: 'boxThree', questions: permanentLeitnerSystem.boxThree, weightPerQ: 1 }
].filter(b => b.questions.length > 0);
      const weightedPool = [];
      boxWeights.forEach(b => {
        const weight = b.questions.length * b.weightPerQ;
        for (let i = 0; i < weight; i++) weightedPool.push(b.box);
      });
      if (weightedPool.length === 0) return null;
      const selectedBox = weightedPool[Math.floor(Math.random() * weightedPool.length)];
      const questionPool = permanentLeitnerSystem[selectedBox];
      const question = questionPool[Math.floor(Math.random() * questionPool.length)];
      return { box: selectedBox, question };
    }

    function checkAnswer() {
      if (!sessionActive) return;
    
      const [a, b] = currentQuestion.split("x").map(Number);
      const correctAnswer = a * b;
      const userAnswer = parseInt(answerEl.value, 10);
      const elapsed = Math.floor((Date.now() - questionStartTime) / 1000);
      const timeUsed = Math.min(elapsed, questionTimeLimit);
    
      totalAnswered++;
      totalTimeSpent += timeUsed;
    
      let feedback = '';
      const isCorrect = userAnswer === correctAnswer && !timedOut;
    
      if (userAnswer === correctAnswer && timedOut) {
        feedback = 'âœ… Correct, but â±ï¸ time ran out.';
        feedbackEl.style.color = 'orange';
        moveQuestion(false);
      } else if (isCorrect) {
        feedback = 'âœ… Correct!';
        feedbackEl.style.color = 'green';
        correctAnswers++;
        moveQuestion(true);
      } else {
        feedback = `âŒ Incorrect. The correct answer was ${correctAnswer}.`;
        feedbackEl.style.color = 'red';
        moveQuestion(false);
      }
    
      updateSessionScore(isCorrect);
    
      feedbackEl.textContent = feedback;
      clearInterval(timer);
      submitBtn.style.display = 'none';
      nextBtn.style.display = 'inline-block';
      answerEl.disabled = true;
    }

    function disableInput() {
      card.classList.add('hidden');
      submitBtn.disabled = true;
      nextBtn.disabled = true;
      answerEl.disabled = true;
    }

    function showSummary() {
      startOverBtn.disabled = true;
      const historyBtn = document.getElementById("historyBtn");
      historyBtn.disabled = true;
    
      globalTimerWrapper.classList.add('hidden');
      clearSessionData();
      const accuracy = totalAnswered > 0
        ? Math.round((correctAnswers / totalAnswered) * 100)
        : 0;
      const correctDisplay = `${correctAnswers}/${totalAnswered} (${accuracy}%)`;
    
      allTimeScore += sessionScore;
      localStorage.setItem("allTimeScore", allTimeScore);
    
      if (sessionScore > highScore) {
        highScore = sessionScore;
        localStorage.setItem("highScore", highScore);
      }
    
      summaryUI.classList.remove('hidden');
      summaryText.innerHTML = `
        <h1 style="font-size: 2.5rem;">Score: ${sessionScore}</h1>
        <p><strong>Difficulty:</strong> ${capitalize(currentDifficulty)}</p>
        <p><strong>Total time:</strong> ${formatTime(userSelectedTime)}</p>
        <p><strong>Correct answers:</strong> ${correctDisplay}</p>
        <p><strong>High Score:</strong> ${highScore}</p>
      `;
    
      if (sessionScore == highScore) {
        celebrateHighScore();
      }
    
      saveLeitnerSystem(tempLeitnerSystem);
      saveProgressToLocalStorage(); // if you've switched from cookies
    
      setTimeout(() => {
        startOverBtn.disabled = false;
        historyBtn.disabled = false;
    
        historyBtn.onclick = showHistory;
      }, 3000);
    }

    // Save performance history in a cookie
function saveProgressToLocalStorage() {
  const STORAGE_KEY = "userProgress";
  const existingData = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  const newEntry = {
    timestamp: new Date().toISOString(),
    difficulty: currentDifficulty,
    timeLength: userSelectedTime,
    score: sessionScore
  };

  existingData.push(newEntry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(existingData));
}

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function celebrateHighScore() {
      summaryText.innerHTML = '<h1 style="font-size: 2.5rem;">ðŸŽ‰ðŸŽ‰ðŸŽ‰ NEW HIGH SCORE! ðŸŽ‰ðŸŽ‰ðŸŽ‰</h1>' + summaryText.innerHTML;
      var duration = 15 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
      
      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }
      
      var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
      
        if (timeLeft <= 0) {
          return clearInterval(interval);
        }
      
        var particleCount = 50 * (timeLeft / duration);
        // since particles fall down, start a bit higher than random
        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
        confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
      }, 250);
    }

    function moveQuestion(correct) {
      const from = currentBox;
      const q = currentQuestion;
      const remove = (arr) => arr.splice(arr.indexOf(q), 1);
      if (from === 'boxOne') {
        remove(tempLeitnerSystem.boxOne);
        correct ? tempLeitnerSystem.boxTwo.push(q) : tempLeitnerSystem.boxOne.push(q);
      } else if (from === 'boxTwo') {
        remove(tempLeitnerSystem.boxTwo);
        correct ? tempLeitnerSystem.boxThree.push(q) : tempLeitnerSystem.boxOne.push(q);
      } else if (from === 'boxThree') {
        remove(tempLeitnerSystem.boxThree);
        correct ? tempLeitnerSystem.boxThree.push(q) : tempLeitnerSystem.boxTwo.push(q);
      }
    }

    function saveLeitnerSystem(system) {
      localStorage.setItem('leitnerSystem', JSON.stringify(system));
    }

    function loadLeitnerSystem() {
      let data = localStorage.getItem('leitnerSystem');
      if (!data) {
        let allQs = [];
        for (let i = 1; i <= 12; i++) {
          for (let j = 1; j <= 12; j++) {
            allQs.push(`${i}x${j}`);
          }
        }
        return {
          boxOne: allQs,
          boxTwo: [],
          boxThree: []
        };
      }
      return JSON.parse(data);
    }

    submitBtn.addEventListener('click', checkAnswer);
    answerEl.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') checkAnswer();
    });
    nextBtn.addEventListener('click', generateProblem);
    window.onload = () => {
      const saved = localStorage.getItem(SESSION_KEY);
      if (saved) {
        const resume = confirm("You have an unfinished session. Would you like to resume it?");
        if (resume) {
          resumeSession(JSON.parse(saved));
        }
      }
    };

    function showHistory() {
      summaryUI.classList.add('hidden');
      document.getElementById('historyScreen').classList.remove('hidden');
      renderHistoryChart();
    }
    
    function renderHistoryChart() {
      const rawData = JSON.parse(localStorage.getItem("userProgress") || "[]");
      const datasets = {};
    
      rawData.forEach((entry, i) => {
        const label = `${entry.timeLength / 60} Minute`;
        if (!datasets[label]) datasets[label] = { label, data: [], borderColor: '', fill: false };
    
        datasets[label].data.push({
          x: i + 1,
          y: entry.score,
          meta: entry
        });
      });
    
      const colors = {
        "1 Minute": "#007bff",
        "5 Minute": "#28a745",
        "10 Minute": "#dc3545"
      };
    
      const finalDatasets = Object.values(datasets).map(ds => {
        const color = colors[ds.label] || '#000';
        return {
          label: ds.label,
          data: ds.data,
          borderColor: color,
          backgroundColor: color,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 8,
          parsing: false,
          segment: {
            borderDash: ctx => ctx.p0.skip || ctx.p1.skip ? [6, 6] : undefined,
          },
        };
      });
    
      const ctx = document.getElementById('historyChart').getContext('2d');
      if (window.historyChart instanceof Chart) {
        window.historyChart.destroy();
      }
    
      window.historyChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: finalDatasets
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const meta = ctx.raw.meta;
                  return [
                    `Score: ${meta.score}`,
                    `Time: ${meta.timeLength / 60} min`,
                    `Difficulty: ${meta.difficulty}`,
                    `Timestamp: ${new Date(meta.timestamp).toLocaleString()}`
                  ];
                }
              }
            },
            legend: {
              display: true,
              position: 'top'
            },
            title: {
              display: true,
              text: 'Performance Over Time'
            }
          },
          scales: {
            x: {
              type: 'linear',
              title: {
                display: true,
                text: 'Attempt #'
              },
              ticks: {
                stepSize: 1
              }
            },
            y: {
              title: {
                display: true,
                text: 'Score'
              },
              beginAtZero: true
            }
          }
        }
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
